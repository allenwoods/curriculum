# å…ƒç¼–ç¨‹

```elixir
Mix.install([
  {:jason, "~> 1.4"},
  {:kino, "~> 0.9", override: true},
  {:youtube, github: "brooklinjazz/youtube"},
  {:hidden_cell, github: "brooklinjazz/hidden_cell"}
])
```

## å¯¼èˆª

<div style="display: flex; align-items: center; width: 100%; justify-content: space-between; font-size: 1rem; color: #61758a; background-color: #f0f5f9; height: 4rem; padding: 0 1rem; border-radius: 1rem;">
<div style="display: flex;">
<i class="ri-home-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="../start.livemd">é¦–é¡µ</a>
</div>
<div style="display: flex;">
<i class="ri-bug-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="https://github.com/DockYard-Academy/curriculum/issues/new?assignees=&labels=&template=issue.md&title=Metaprogramming">æŠ¥å‘Šé—®é¢˜</a>
</div>
<div style="display: flex;">
<i class="ri-arrow-left-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="../exercises/advanced_score_tracker.livemd">é«˜çº§åˆ†æ•°è·Ÿè¸ªå™¨</a>
</div>
<div style="display: flex;">
<a style="display: flex; color: #61758a; margin-right: 1rem;" href="../exercises/meta_math.livemd">MetaMath</a>
<i class="ri-arrow-right-fill"></i>
</div>
</div>

## å¤ä¹ é—®é¢˜

å®Œæˆæœ¬è¯¾åï¼Œå­¦ç”Ÿåº”è¯¥èƒ½å¤Ÿå›ç­”ä»¥ä¸‹é—®é¢˜ã€‚

* `use` å…³é”®å­—çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ
* å®å’Œå‡½æ•°ä¹‹é—´æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

## æ¦‚è¿°

### ç¼–è¯‘æ—¶ä¸è¿è¡Œæ—¶

åœ¨ç¼–ç¨‹ä¸­ï¼Œç¼–è¯‘æ—¶æŒ‡çš„æ˜¯ç¨‹åºä»æºä»£ç ç¼–è¯‘æˆå¯æ‰§è¡Œæœºå™¨ä»£ç çš„æ—¶é—´æ®µï¼Œè€Œè¿è¡Œæ—¶æŒ‡çš„æ˜¯ç¨‹åºæ‰§è¡Œçš„æ—¶é—´æ®µã€‚

<!-- livebook:{"break_markdown":true} -->

### [OTP](https://en.wikipedia.org/wiki/Open_Telecom_Platform)

å¼€æ”¾ç”µä¿¡å¹³å°ï¼ˆOTPï¼‰æ˜¯ä¸€ä¸ªç”¨äºæ„å»ºå¹¶å‘ã€å®¹é”™å’Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„ Erlang åº“å’Œå·¥å…·çš„é›†åˆã€‚

<!-- livebook:{"break_markdown":true} -->

### [BEAMï¼ˆErlang è™šæ‹Ÿæœºï¼‰](https://en.wikipedia.org/wiki/BEAM_(Erlang_virtual_machine))

BEAM æ˜¯ Erlang å’Œ Elixir çš„è¿è¡Œæ—¶ç¯å¢ƒã€‚å®ƒæ˜¯ä¸€ä¸ªåœ¨å¤šç§å¹³å°ä¸Šè¿è¡Œçš„è™šæ‹Ÿæœºï¼ŒåŒ…æ‹¬ç±» Unix æ“ä½œç³»ç»Ÿã€Windows å’Œ MacOSã€‚æˆ‘ä»¬é€šå¸¸å°† **Erlang è™šæ‹Ÿæœº** å’Œ **BEAM** è¿™ä¸¤ä¸ªæœ¯è¯­äº’æ¢ä½¿ç”¨ã€‚

Elixir ç¼–è¯‘å™¨å°† Elixir æºä»£ç ç¼–è¯‘æˆåœ¨ BEAM ä¸Šæ‰§è¡Œçš„ [å­—èŠ‚ç ](https://en.wikipedia.org/wiki/Bytecode) `.beam` æ–‡ä»¶ã€‚

BEAM æ˜¯ Erlang è¿è¡Œæ—¶ç³»ç»Ÿï¼ˆERTSï¼‰çš„ä¸€éƒ¨åˆ†ã€‚

<!-- livebook:{"break_markdown":true} -->

### [Erlang è¿è¡Œæ—¶ç³»ç»Ÿ](https://www.erlang.org/doc/apps/erts/erts.pdf)

Erlang è¿è¡Œæ—¶ç³»ç»Ÿï¼ˆERTSï¼‰æ˜¯å¼€æ”¾ç”µä¿¡å¹³å°ï¼ˆOTPï¼‰çš„ä¸€ä¸ªç»„ä»¶ï¼Œè´Ÿè´£åœ¨ Erlang è™šæ‹Ÿæœºï¼ˆVMï¼‰ä¸Šæ‰§è¡Œ Erlang å’Œ Elixir ç¨‹åºã€‚BEAM è™šæ‹Ÿæœºæ˜¯ Erlang è¿è¡Œæ—¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ã€‚

<!-- livebook:{"break_markdown":true} -->

### [æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰](https://en.wikipedia.org/wiki/Abstract_syntax_tree)

æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰æ˜¯ç¨‹åºæºä»£ç ç»“æ„çš„æ ‘çŠ¶æ•°æ®ç»“æ„è¡¨ç¤ºã€‚Elixir AST è¢« Elixir ç¼–è¯‘å™¨ç”¨æ¥å°† Elixir ä»£ç è½¬æ¢ä¸ºå¯ä»¥ç”± BEAM è™šæ‹Ÿæœºæ‰§è¡Œçš„å­—èŠ‚ç ã€‚Elixir ç¼–è¯‘å™¨å°† Elixir ä»£ç è½¬æ¢ä¸º ASTï¼Œç„¶åä½¿ç”¨ AST ç”Ÿæˆå­—èŠ‚ç ã€‚

AST æä¾›äº†æºä»£ç çš„æ–¹ä¾¿ä¸­é—´è¡¨ç¤ºï¼Œå¯ä»¥åœ¨ä»£ç è¢«ç¿»è¯‘æˆå­—èŠ‚ç ä¹‹å‰å¯¹å…¶è¿›è¡Œå„ç§ä¼˜åŒ–å’Œè½¬æ¢ã€‚

<!-- livebook:{"break_markdown":true} -->

### å…ƒç¼–ç¨‹

å…ƒç¼–ç¨‹æ˜¯ç¼–å†™ç”Ÿæˆä»£ç çš„ä»£ç çš„è¿‡ç¨‹ã€‚

åœ¨ Elixir ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å®è¿›è¡Œä»£ç ç”Ÿæˆã€‚å®æ˜¯ç”Ÿæˆä»£ç çš„å¼ºå¤§å·¥å…·ã€‚ç„¶è€Œï¼Œå®ƒä»¬å¯èƒ½å¯¼è‡´é¢å¤–çš„å¤æ‚æ€§ï¼Œå› æ­¤åº”è°¨æ…ä½¿ç”¨ã€‚

> å°½ç®¡ Elixir å°½åŠ›ä¸ºå®æä¾›å®‰å…¨ç¯å¢ƒï¼Œä½†ç¼–å†™å¹²å‡€ä»£ç çš„ä¸»è¦è´£ä»»ä»ç„¶åœ¨äºå¼€å‘è€…ã€‚å®æ¯”æ™®é€šçš„ Elixir å‡½æ•°æ›´éš¾ç¼–å†™ï¼Œå½“ä¸å¿…è¦æ—¶ä½¿ç”¨å®ƒä»¬è¢«è®¤ä¸ºæ˜¯åé£æ ¼ã€‚å› æ­¤ï¼Œè¯·è´Ÿè´£ä»»åœ°ç¼–å†™å®ã€‚
> 
> * [elixir-lang.org](https://elixir-lang.org/getting-started/meta/macros.html)

æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•åˆ©ç”¨å…ƒç¼–ç¨‹æ‰©å±• Elixir è¯­è¨€å¹¶æœ€å°åŒ–æ ·æ¿ä»£ç ã€‚

è™½ç„¶æˆ‘ä»¬åœ¨æ—¥å¸¸ç¼–ç¨‹ä¸­ä¸å¤ªå¯èƒ½ä½¿ç”¨å…ƒç¼–ç¨‹ï¼ˆè¿™å–å†³äºä½ æ­£åœ¨æ„å»ºçš„å†…å®¹ï¼‰ï¼Œä½†æˆ‘ä»¬å°†ä½¿ç”¨å…ƒç¼–ç¨‹æ¥æ›´å¥½åœ°ç†è§£ Elixir çš„å†…éƒ¨å·¥ä½œåŸç†ã€‚

## å¼•ç”¨

åœ¨åº•å±‚ï¼ŒElixir å°†è¡¨è¾¾å¼è¡¨ç¤ºä¸ºä¸‰å…ƒç»„ã€‚
æˆ‘ä»¬ç§°è¿™ç§è¡¨ç¤ºä¸º [ASTï¼ˆæŠ½è±¡è¯­æ³•æ ‘ï¼‰](https://en.wikipedia.org/wiki/Abstract_syntax_tree)ã€‚Elixir å…è®¸æˆ‘ä»¬ä½¿ç”¨ `quote` å®æ£€æŸ¥è¡¨è¾¾å¼çš„ AST è¡¨ç¤ºã€‚

```elixir
quote do
  2 + 2
end
```

ä¸Šé¢çš„ä¸‰å…ƒç»„é€šå¸¸ç§°ä¸º **å¼•ç”¨è¡¨è¾¾å¼**ã€‚

å…ƒç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯å‡½æ•°åã€‚
ç¬¬äºŒä¸ªå…ƒç´ æ˜¯åŒ…å«å…ƒæ•°æ®çš„å…³é”®å­—åˆ—è¡¨ï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯å‚æ•°åˆ—è¡¨ã€‚

`{function, metadata, arguments}`

å› æ­¤ï¼Œ`2 + 2` ä½œä¸ºå¼•ç”¨è¡¨è¾¾å¼æ˜¯

* å‡½æ•°: `:+`
* å…ƒæ•°æ®: `[context: Elixir, import: Kernel]`
* å‚æ•°: `[2, 2]`

å‡½æ•°åæ˜¯ `:+`ï¼Œå®ƒæŒ‡çš„æ˜¯ `Kernel.+/2` å‡½æ•°ã€‚`+` åªæ˜¯è°ƒç”¨æ­¤å‡½æ•°çš„ä¾¿æ·è¯­æ³•ã€‚

```elixir
Kernel.+(2, 2) == 2 + 2
```

å…ƒæ•°æ®åŒ…å«æœ‰å…³ç¯å¢ƒçš„ä¿¡æ¯ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ`:context` æ˜¯ `Elixir`ï¼Œå› ä¸ºæˆ‘ä»¬å¤„äºé¡¶å±‚ä½œç”¨åŸŸã€‚

å¦‚æœæˆ‘ä»¬åœ¨æ¨¡å—ä¸­ä½¿ç”¨ `quote`ï¼Œä¸Šä¸‹æ–‡ä¼šå‘ç”Ÿå˜åŒ–ã€‚ç°åœ¨ä¸Šä¸‹æ–‡å°†æ˜¯æ¨¡å—çš„åç§°ã€‚

```elixir
defmodule MyModule do
  def example do
    quote do
      2 + 2
    end
  end
end

MyModule.example()
```

æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨å•è¡Œä¸Šè°ƒç”¨ `quote`ã€‚

```elixir
quote do: 1 - 1
```

AST å°†åŸå§‹æ•°æ®ç±»å‹è¡¨ç¤ºä¸ºå®ƒä»¬æœ¬èº«ï¼Œè€Œä¸æ˜¯ä¸‰å…ƒç»„ã€‚

```elixir
quote do: 2
```

æ‰€æœ‰å…¶ä»–è¡¨è¾¾å¼å°†æ˜¯ä¸‰å…ƒç»„â€”â€”å³ä½¿æ˜¯éåŸå§‹æ•°æ®ç±»å‹ï¼Œå¦‚æ˜ å°„ã€‚

```elixir
quote do: %{key: "value"}
```

è¿™æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ä½œä¸ºå¼•ç”¨è¡¨è¾¾å¼ã€‚

```elixir
sum = fn int1, int2, int3 -> int1 + int2 + int3 end

quote do: sum(1, 2, 3)
```

è¿™æ˜¯ä¸€ä¸ªå‘½åå‡½æ•°ä½œä¸ºå¼•ç”¨è¡¨è¾¾å¼ã€‚

```elixir
defmodule Math do
  def sum(int1, int2, int3) do
    int1 + int2 + int3
  end
end

quote do: Math.sum(1, 2, 3)
```

ä¸‰å…ƒç»„ä¸­çš„å‚æ•°æœ¬èº«ä¹Ÿå¯ä»¥æ˜¯ä¸‰å…ƒç»„ã€‚

```elixir
quote do: sum(1, 2, sum(1, 2, 3))
```

### ä½ çš„å›åˆ

ä½¿ç”¨ `quote` å®å‘ç°ä»¥ä¸‹è¡¨è¾¾å¼çš„ AST è¡¨ç¤ºã€‚ä½ ä¹Ÿå¯ä»¥é€‰æ‹©ç”¨å…¶ä»– Elixir è¡¨è¾¾å¼å®éªŒ `quote`ï¼Œä»¥æŸ¥çœ‹å®ƒä»¬çš„å¼•ç”¨è¡¨è¾¾å¼è¡¨ç¤ºã€‚

<!-- livebook:{"force_markdown":true} -->

```elixir
2 + 2 + 2
```

```elixir

```

## å–æ¶ˆå¼•ç”¨

`unquote` å°†ä»£ç æ³¨å…¥åˆ° `quote` å®ä¸­ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `unquote` å°†ä¸€äº›è®¡ç®—å€¼æ³¨å…¥åˆ° `quote` å—ä¸­ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹ `unquote(1 + 1)` åœ¨ `quote` å—å†…è¯„ä¼°ä¸º `2`ã€‚

```elixir
quote do
  2 + unquote(1 + 1)
end
```

ä¸Šé¢çš„ `quote` è¡¨è¾¾å¼ç­‰åŒäº `2 + 2`ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨ `unquote` å°† `1 + 1` çš„ç»“æœæ³¨å…¥åˆ° `quote` è¡¨è¾¾å¼ä¸­ã€‚

```elixir
quote do
  2 + 2
end
```

è¯·æ³¨æ„ï¼Œè¿™ä¸ `2 + 1 + 1` çš„ AST ä¸åŒï¼Œåè€…åˆ†è§£ä¸ºå¤šä¸ªä¸‰å…ƒç»„ï¼Œå› ä¸ºå®ƒå®é™…ä¸Šæ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„åŠ æ³•è¡¨è¾¾å¼ã€‚

```elixir
quote do
  2 + 1 + 1
end
```

åœ¨å¼•ç”¨å—å¤–çš„å˜é‡åœ¨å¼•ç”¨å—å†…ä¸å¯ç”¨ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `unquote` æ³¨å…¥å®ƒä»¬çš„è¯„ä¼°å€¼ã€‚

```elixir
my_variable = 5

quote do
  2 + unquote(my_variable)
end
```

è¿™åˆ›å»ºäº†ä¸ `2 + 5` ç›¸åŒçš„å¼•ç”¨è¡¨è¾¾å¼ã€‚

```elixir
quote do
  2 + 5
end
```

## å®å’Œä»£ç æ¨¡å—

Elixir [Code](https://hexdocs.pm/elixir/Code.html) æ¨¡å—æ˜¯ Elixir æ ‡å‡†åº“ä¸­çš„ä¸€ä¸ªæ¨¡å—ï¼Œæä¾›ç”¨äºåœ¨è¿è¡Œæ—¶å¤„ç†ä»£ç çš„å‡½æ•°ã€‚[Code](https://hexdocs.pm/elixir/Code.html) æ¨¡å—æä¾›äº†å‡ ä¸ªç”¨äºè¯„ä¼°ä»£ç çš„å‡½æ•°ï¼Œå¦‚ [Code.eval_string/2](https://hexdocs.pm/elixir/Code.html#eval_string/2) å’Œ [Code.eval_quoted/2](https://hexdocs.pm/elixir/Code.html#eval_quoted/2)ï¼Œå…è®¸ä½ æ ¹æ®è¿è¡Œæ—¶æ¡ä»¶åŠ¨æ€ç”Ÿæˆå’Œæ‰§è¡Œä»£ç ã€‚

Code æ¨¡å—è¿˜æä¾›ç”¨äºå¤„ç† Elixir ä»£ç çš„æŠ½è±¡è¯­æ³•æ ‘ï¼ˆASTï¼‰çš„å‡½æ•°ï¼Œå¦‚ [Code.string_to_quoted/1](https://hexdocs.pm/elixir/Code.html#string_to_quoted/1)ï¼Œå…è®¸ä½ åœ¨ Elixir ä»£ç ä½œä¸ºå­—ç¬¦ä¸²å’Œä»£ç çš„ AST è¡¨ç¤ºä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚

[Macro](https://hexdocs.pm/elixir/Macro.html) æ¨¡å—åŒ…å«ç”¨äºæ“ä½œ AST å’Œå®ç°å®çš„å‡½æ•°ã€‚[Macro](https://hexdocs.pm/elixir/Macro.html) æ¨¡å—æä¾›äº† [Macro.to_string/1](https://hexdocs.pm/elixir/Macro.html#to_string/1) å‡½æ•°ã€‚

Code æ¨¡å—é€šå¸¸ä¸ Elixir ä¸­çš„å…ƒç¼–ç¨‹æŠ€æœ¯ç»“åˆä½¿ç”¨ï¼Œå› ä¸ºå®ƒå…è®¸ä½ åœ¨è¿è¡Œæ—¶æ“ä½œå’Œæ‰§è¡Œä»£ç ã€‚ç„¶è€Œï¼Œé‡è¦çš„æ˜¯è¦è°¨æ…ä½¿ç”¨è¿™äº›å‡½æ•°ï¼Œå› ä¸ºåŠ¨æ€ç”Ÿæˆå’Œæ‰§è¡Œä»£ç å¯èƒ½å¤æ‚ä¸”éš¾ä»¥ç†è§£ï¼Œå¦‚æœä½¿ç”¨ä¸å½“å¯èƒ½ä¼šäº§ç”Ÿæ„æƒ³ä¸åˆ°çš„åæœã€‚

<!-- livebook:{"break_markdown":true} -->

### è¯»å– AST

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [Macro.to_string/1](https://hexdocs.pm/elixir/Macro.html#to_string/1) å°†å¼•ç”¨è¡¨è¾¾å¼è½¬æ¢ä¸º Elixir è¡¨è¾¾å¼ï¼ˆä»¥å­—ç¬¦ä¸²å½¢å¼ï¼‰ã€‚

```elixir
quoted = quote do: 2 + 2

Macro.to_string(quoted)
```

æˆ‘ä»¬å¯ä»¥ç›´æ¥æä¾› AST ä½œä¸ºä¸‰å…ƒç»„ã€‚

```elixir
ast = {:+, [context: Elixir, imports: [{1, Kernel}, {2, Kernel}]], [2, 5]}

Macro.to_string(ast)
```

### å°†å­—ç¬¦ä¸²ä½œä¸ºæºä»£ç è¯„ä¼°

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [Code.eval_string/3](https://hexdocs.pm/elixir/Code.html#eval_string/3) å‡½æ•°è¯„ä¼°å­—ç¬¦ä¸²ä½œä¸º Elixir ä»£ç ã€‚

```elixir
Code.eval_string("2 + 5")
```

å­—ç¬¦ä¸²ä¸­çš„å˜é‡å¯ä»¥é€šè¿‡å°†ç»‘å®šçš„å…³é”®å­—åˆ—è¡¨ä½œä¸ºå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°æä¾›ã€‚

```elixir
Code.eval_string("2 + a", a: 2)
```

### è¯„ä¼° AST

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ [Code.eval_quoted/2](https://hexdocs.pm/elixir/Code.html#eval_quoted/2) å‡½æ•°è¯„ä¼° ASTã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬è·å–ä¸€ä¸ªå¼•ç”¨è¡¨è¾¾å¼å¹¶è¯„ä¼°å®ƒä»¥æ‰¾åˆ°ç»“æœã€‚

```elixir
quoted =
  quote do
    2 + 2
  end

Code.eval_quoted(quoted)
```

å¼•ç”¨è¡¨è¾¾å¼æ— æ³•è®¿é—®ç»‘å®šçš„å˜é‡ã€‚ä¸‹é¢æˆ‘ä»¬å°†çœ‹åˆ° `a` åœ¨å¼•ç”¨è¡¨è¾¾å¼ä¸­æœªå®šä¹‰ã€‚

```elixir
a = 2

quoted =
  quote do
    a + 2
  end

Code.eval_quoted(quoted)
```

ä¸ºäº†è®¿é—®å˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `unquote` å°†å…¶è¯„ä¼°åˆ°å¼•ç”¨è¡¨è¾¾å¼ä¸­ã€‚

```elixir
a = 2

quoted =
  quote do
    unquote(a) + 2
  end

Code.eval_quoted(quoted)
```

æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ [Code.eval_quoted/2](https://hexdocs.pm/elixir/Code.html#eval_quoted/2) å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­æä¾›å˜é‡ç»‘å®šçš„å…³é”®å­—åˆ—è¡¨ã€‚

```elixir
quoted =
  quote do
    unquote(a) + 2
  end

Code.eval_quoted(quoted, a: 2)
```

## å®

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®æ‰©å±• Elixir è¯­è¨€æˆ–åˆ›å»º [DSLï¼ˆé¢†åŸŸç‰¹å®šè¯­è¨€ï¼‰](https://en.wikipedia.org/wiki/Domain-specific_language)ã€‚ä¾‹å¦‚ï¼Œæ¯æ¬¡ä½ åœ¨ ExUnit ä¸­ä½¿ç”¨ `test` å’Œ `assert` æ—¶ï¼Œä½ éƒ½åœ¨ä½¿ç”¨ ExUnit å®ã€‚

```elixir
ExUnit.start(auto_run: false)

defmodule Test do
  use ExUnit.Case

  test "example" do
    assert 1 == 2
  end
end

ExUnit.run()
```

é€šå¸¸ï¼Œä½¿ç”¨å®æ—¶ä¸å¸¦åœ†æ‹¬å·æ˜¯æƒ¯ç”¨çš„ã€‚ç„¶è€Œï¼Œæ²¡æœ‰ä»€ä¹ˆå¯ä»¥é˜»æ­¢ä½ åœ¨å®ä¸­ä½¿ç”¨æ‹¬å·ã€‚`do end` å—å®é™…ä¸Šåªæ˜¯å°†å…³é”®å­—åˆ—è¡¨ä½œä¸ºå‚æ•°çš„å¦ä¸€ç§è¯­æ³•ã€‚

```elixir
ExUnit.start(auto_run: false)

defmodule BracketExample do
  use ExUnit.Case

  test("example", do: assert(1 == 1))
end

ExUnit.run()
```

Elixir è¯­æ³•çš„è®¸å¤šéƒ¨åˆ†æ˜¯é€šè¿‡å®å®ç°çš„ã€‚åƒ `def` è¿™æ ·çš„å…³é”®å­—å®é™…ä¸Šåªæ˜¯ [Kernel](https://hexdocs.pm/elixir/Kernel.html) æ¨¡å—ä¸Šçš„å®ï¼Œè€Œ `do end` å—å®é™…ä¸Šåªæ˜¯ä½œä¸ºå‚æ•°æä¾›ç»™å®çš„å…³é”®å­—åˆ—è¡¨ã€‚ğŸ¤¯

```elixir
Kernel.defmodule(Mind, do: Kernel.def(blown, do: "ğŸ¤¯"))

Mind.blown()
```

## ç¼–å†™æˆ‘ä»¬è‡ªå·±çš„å®

ä¸å‡½æ•°ä¸åŒï¼Œå®åœ¨ç¼–è¯‘æ—¶å±•å¼€ï¼Œå› æ­¤å®ƒä»¬ä¿ç•™äº†è°ƒç”¨æ—¶çš„å€¼çš„çŸ¥è¯†ã€‚

è¯·æ³¨æ„ï¼ŒExUnit å¯ä»¥ç¡®å®šåœ¨æ–­è¨€ `assert 1 == 2` ä¸­ä½¿ç”¨çš„è¿ç®—ç¬¦å’Œå€¼ï¼Œä»¥æä¾›æµ‹è¯•åé¦ˆã€‚

<!-- livebook:{"force_markdown":true} -->

```elixir
"""
ä½¿ç”¨ `==` çš„æ–­è¨€å¤±è´¥ã€‚

å·¦ä¾§: 1
å³ä¾§: 2
"""
```

ä¸ºäº†ç†è§£ ExUnit å¦‚ä½•åˆ©ç”¨å®çš„åŠ›é‡æä¾›æ›´å¥½çš„æµ‹è¯•åé¦ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºè‡ªå·±çš„ `assert` å®ã€‚

`assert` å®å°†æ¥å—ä¸€ä¸ªçœŸå€¼è¡¨è¾¾å¼å¹¶æ‰“å°å¸¦æœ‰åé¦ˆçš„æ¶ˆæ¯ã€‚è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ— æ³•é€šè¿‡å‡½æ•°å®ç°è¿™ä¸€ç‚¹ã€‚å‡½æ•°æ¥å—è¡¨è¾¾å¼çš„è¯„ä¼°ç»“æœä½œä¸ºå‚æ•°ã€‚æˆ‘ä»¬å¤±å»äº†æœ‰å…³è¿ç®—ç¬¦å’Œå€¼çš„ä¸Šä¸‹æ–‡ã€‚

```elixir
inspect_argument = fn expression ->
  IO.inspect(expression, label: "è¡¨è¾¾å¼çš„è¯„ä¼°ç»“æœ")
end

inspect_argument.(1 == 2)
```

æˆ‘ä»¬ä½¿ç”¨ `defmacro` å®šä¹‰ä¸€ä¸ªå®ã€‚

è¡¨è¾¾å¼çš„ AST è¡¨ç¤ºçŸ¥é“å®è¢«è°ƒç”¨æ—¶çš„å‡½æ•°å’Œå‚æ•°ã€‚

```elixir
defmodule ASTInspector do
  defmacro inspect(ast) do
    IO.inspect(ast, label: "ast")
  end
end
```

è¦ä½¿ç”¨å®ï¼Œæˆ‘ä»¬éœ€è¦ `require` å®ƒã€‚

```elixir
require ASTInspector

ASTInspector.inspect(2 == 1)
```

åœ¨è¿™ä¸ª AST å…ƒç»„ä¸­ï¼Œæˆ‘ä»¬æ‹¥æœ‰è·å– `operator`ã€è¡¨è¾¾å¼çš„ `left` ä¾§å’Œ `right` ä¾§æ‰€éœ€çš„ä¸€åˆ‡ã€‚

```elixir
defmodule ExpressionInspector do
  defmacro inspect({operator, _meta, [left, right]}) do
    IO.inspect(operator, label: "è¿ç®—ç¬¦")
    IO.inspect(left, label: "å·¦ä¾§")
    IO.inspect(right, label: "å³ä¾§")
  end
end
```

```elixir
require ExpressionInspector

ExpressionInspector.inspect(2 == 2)
```

æˆ‘ä»¬æƒ³è¦éªŒè¯ `left` å’Œ `right` å€¼æ˜¯å¦ç›¸ç­‰ã€‚æˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ª `Assertion.Test` æ¨¡å—ï¼Œä½¿ç”¨æ¨¡å¼åŒ¹é…è¿”å›æˆåŠŸæ¶ˆæ¯æˆ–å¤±è´¥æ–­è¨€æ¶ˆæ¯ï¼Œå…·ä½“å–å†³äº `left` å’Œ `right` ä¾§æ˜¯å¦ç›¸ç­‰ã€‚

```elixir
defmodule Assertion.Test do
  def assert(:==, left, right) when left == right do
    "æˆåŠŸï¼"
  end

  def assert(:==, left, right) do
    """
    ä½¿ç”¨ == çš„æ–­è¨€å¤±è´¥ã€‚
    å·¦ä¾§: #{left}
    å³ä¾§: #{right}
    """
  end
end

Assertion.Test.assert(:==, 1, 2) |> IO.puts()
```

ç„¶åæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®è·å– `operator`ã€`left` å’Œ `right` å€¼ï¼Œä»¥ä¾¿ä¸æˆ‘ä»¬çš„ `Assertion.Test` æ¨¡å—ä¸€èµ·ä½¿ç”¨ã€‚

å®ç”Ÿæˆä»£ç ï¼Œå› æ­¤é€šå¸¸å®ƒåº”è¯¥è¿”å›ä¸€ä¸ª AST è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯è¿”å›å€¼ã€‚æˆ‘ä»¬ä½¿ç”¨ `quote` åˆ›å»ºå‡½æ•°è°ƒç”¨çš„ AST è¡¨ç¤ºã€‚æˆ‘ä»¬è¿˜éœ€è¦ä½¿ç”¨ `unquote` åœ¨å¼•ç”¨å—ä¸­ä½¿ç”¨ç»‘å®šå˜é‡ã€‚å‚æ•°ä¹Ÿæ˜¯å¦‚æ­¤ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ `unquote` å°†å®ƒä»¬çš„è¯„ä¼°å€¼æ³¨å…¥åˆ° `quote` å—ä¸­ã€‚

```elixir
defmodule Assertion do
  defmacro assert({operator, _meta, [left, right]}) do
    quote do
      Assertion.Test.assert(unquote(operator), unquote(left), unquote(right))
    end
  end
end
```

å½“æˆ‘ä»¬åœ¨ä¸‹é¢è°ƒç”¨ `assert` å®æ—¶ï¼Œå®ƒç¼–è¯‘ä¸º `Assertion.Test.assert(:==, 1, 2)`ï¼Œç„¶ååœ¨è¿è¡Œæ—¶è¯„ä¼°ã€‚

```elixir
require Assertion

Assertion.assert(1 == 2) |> IO.puts()
```

æˆ–è€…ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `bind_quoted` å°†å¤šä¸ªå€¼ç»‘å®šåˆ°å¼•ç”¨è¡¨è¾¾å¼ï¼Œè€Œæ— éœ€ä½¿ç”¨ `unquote`ã€‚è¿™åªæ˜¯é¿å…å¤šæ¬¡ä½¿ç”¨ `unquote` çš„è¯­æ³•ç³–ã€‚

```elixir
defmodule AssertionWithBindQuoted do
  defmacro assert({operator, _meta, [left, right]}) do
    quote bind_quoted: [operator: operator, left: left, right: right] do
      Assertion.Test.assert(operator, left, right)
    end
  end
end
```

å®ç»§ç»­æŒ‰é¢„æœŸå·¥ä½œã€‚

```elixir
require AssertionWithBindQuoted

AssertionWithBindQuoted.assert(1 == 2) |> IO.puts()
```

## ä½¿ç”¨å’Œ __using__

è™½ç„¶ä½ å¯èƒ½ä¸ä¼šç»å¸¸ç¼–å†™å®ï¼Œä½†ä½ å¯èƒ½æ¯å¤©éƒ½ä¼šä½¿ç”¨å®ƒä»¬ã€‚
ä¾‹å¦‚ï¼Œæˆ‘ä»¬å·²ç»ä¾èµ–äº `use` å…³é”®å­—ä¸­çš„å®ã€‚

å½“æˆ‘ä»¬ `use GenServer` æ—¶ï¼Œä¸€ä¸ªå®ç”Ÿæˆå¿…è¦çš„æ ·æ¿ä»£ç ä»¥åˆ›å»ºä¸€ä¸ª [GenServer](https://hexdocs.pm/elixir/GenServer.html)ã€‚

```elixir
defmodule Server do
  use GenServer

  def init(state) do
    {:ok, state}
  end
end
```

æˆ‘ä»¬å¯ä»¥åœ¨ `Server` æ¨¡å—ä¸Šä½¿ç”¨ `__info__/2` å‡½æ•°æ¥æ·±å…¥äº†è§£åº•å±‚ç”Ÿæˆçš„ä»£ç ã€‚åœ¨è¿™é‡Œæˆ‘ä»¬çœ‹åˆ°å®ƒå®šä¹‰äº†å‡ ä¸ªå‡½æ•°ã€‚

```elixir
Server.__info__(:functions)
```

`use` å…³é”®å­—ä¸ºä½¿ç”¨å®æä¾›äº†ä¸€ä¸ªå¹²å‡€ä¸”å—æ§çš„æ¥å£ã€‚åœ¨åº•å±‚ï¼Œ`use` å…³é”®å­—åœ¨æŒ‡å®šæ¨¡å—ä¸­è°ƒç”¨ä¸€ä¸ª `__using__` å®ã€‚

```elixir
defmodule Template do
  defmacro __using__(_opts) do
    quote do
      def template_function do
        "hello"
      end
    end
  end
end
```

ä»æ¦‚å¿µä¸Šè®²ï¼Œè€ƒè™‘å®šä¹‰å®çš„æ¨¡å—ä½œä¸ºæ¨¡æ¿æˆ–æˆ‘ä»¬å¯ä»¥åœ¨ç¨‹åºä¸­é‡ç”¨çš„é€šç”¨æ¨¡å¼å¯èƒ½ä¼šæœ‰æ‰€å¸®åŠ©ã€‚ä¾‹å¦‚ï¼Œ[GenServer](https://hexdocs.pm/elixir/GenServer.html) æ˜¯æˆ‘ä»¬å¸Œæœ›æ‰©å±•å’Œé‡ç”¨çš„å¸¸è§æ¨¡å¼ã€‚

```elixir
defmodule ExtendedTemplate do
  use Template

  def extended_function() do
    template_function() <> " world"
  end
end
```

ä¸€æ—¦æˆ‘ä»¬å®šä¹‰äº†æˆ‘ä»¬çš„æ¨¡å¼ï¼Œå°±å¯ä»¥åœ¨æ•´ä¸ªç¨‹åºä¸­é‡ç”¨å®ƒå¹¶æ‰©å±•å…¶åŠŸèƒ½ã€‚

```elixir
ExtendedTemplate.template_function()
```

```elixir
ExtendedTemplate.extended_function()
```

åœ¨ç°å®ä¸–ç•Œçš„ä¾‹å­ä¸­ï¼Œé€šå¸¸ä¼šä¸ºå¸¸è§æµ‹è¯•åœºæ™¯åˆ›å»ºè‡ªå®šä¹‰ ExUnit ç”¨ä¾‹ã€‚ä¸‹é¢çš„ç¤ºä¾‹åªæ˜¯å¯èƒ½æ€§çš„ä¸€ä¸ªå°ç¤ºä¾‹ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `IOCase` æ¨¡å—ï¼Œå®ƒè‡ªåŠ¨å¯¼å…¥ `ExUnit.CaptureIO` æ¨¡å—ï¼Œè¯¥æ¨¡å—æä¾›ç”¨äºæµ‹è¯•æˆ‘ä»¬æ˜¯å¦ä½¿ç”¨ [IO](https://hexdocs.pm/elixir/IO.html) æ‰“å°æ¶ˆæ¯çš„ [capture_io/1](https://hexdocs.pm/ex_unit/ExUnit.CaptureIO.html#capture_io/1)ã€‚

```elixir
defmodule IOCase do
  # ä½¿ç”¨è¯¥æ¨¡å—
  defmacro __using__(_opts) do
    quote do
      use ExUnit.Case
      import ExUnit.CaptureIO
    end
  end
end

ExUnit.start(auto_run: false)

defmodule IOTest do
  use IOCase

  test "æ•è· IO" do
    capture_io(fn -> IO.puts("hello") end) =~ "hello"
  end
end

ExUnit.run()
```

### ä½ çš„å›åˆ

åˆ›å»ºä¸€ä¸ª `Greetings` æ¨¡å—ï¼Œå¸¦æœ‰ä¸€ä¸ª `__using__` å®ã€‚åœ¨ `__using__` å®å†…éƒ¨å®šä¹‰ä¸€ä¸ª `hello/0` å‡½æ•°ã€‚ä½ å¯ä»¥é€‰æ‹©å®éªŒå®šä¹‰å…¶ä»–å‡½æ•°æˆ–æ¨¡å—å±æ€§ã€‚

<!-- livebook:{"force_markdown":true} -->

```elixir
def hello do
  "hello"
end
```

åˆ›å»ºä¸€ä¸ª `Usage` æ¨¡å—ï¼Œä½¿ç”¨ `use` å…³é”®å­—è°ƒç”¨ `Greetings` æ¨¡å—ä¸­çš„ `__using__` å®ã€‚

```elixir
defmodule Greetings do
end

defmodule Usage do
end
```

è°ƒç”¨ `Usage.hello()` ä»¥ç¡®ä¿ä½ çš„è§£å†³æ–¹æ¡ˆæ­£å¸¸å·¥ä½œã€‚

```elixir
Usage.hello()
```

## æ·±å…¥é˜…è¯»

è€ƒè™‘ä»¥ä¸‹èµ„æºä»¥åŠ æ·±ä½ å¯¹è¯¥ä¸»é¢˜çš„ç†è§£ã€‚

* [Elixir å­¦æ ¡ï¼šå…ƒç¼–ç¨‹](https://elixirschool.com/en/lessons/advanced/metaprogramming/)
* [PragProgï¼šå…ƒç¼–ç¨‹ Elixir](https://pragprog.com/titles/cmelixir/metaprogramming-elixir/)

## æäº¤ä½ çš„è¿›åº¦

DockYard Academy ç°åœ¨å»ºè®®ä½ ä½¿ç”¨æœ€æ–°çš„ [Release](https://github.com/DockYard-Academy/curriculum/releases)ï¼Œè€Œä¸æ˜¯åˆ†å‰æˆ–å…‹éš†æˆ‘ä»¬çš„ä»“åº“ã€‚

è¿è¡Œ `git status` ä»¥ç¡®ä¿æ²¡æœ‰ä¸å¿…è¦çš„æ›´æ”¹ã€‚
ç„¶ååœ¨ `curriculum` æ–‡ä»¶å¤¹ä¸­ä»å‘½ä»¤è¡Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥æäº¤ä½ çš„è¿›åº¦ã€‚

```
$ git add .
$ git commit -m "å®Œæˆå…ƒç¼–ç¨‹é˜…è¯»"
$ git push
```

æˆ‘ä»¬è‡ªè±ªåœ°æä¾›æˆ‘ä»¬çš„å¼€æºè¯¾ç¨‹ï¼Œä¾›ä»»ä½•äººå…è´¹å­¦ä¹ ï¼ŒæŒ‰è‡ªå·±çš„èŠ‚å¥è¿›è¡Œã€‚

æˆ‘ä»¬è¿˜æä¾›ä»˜è´¹è¯¾ç¨‹ï¼Œä½ å¯ä»¥åœ¨åŒä¼´çš„é™ªä¼´ä¸‹å‘è®²å¸ˆå­¦ä¹ ã€‚
æˆ‘ä»¬å°†å¾ˆå¿«æ¥å— 2023 å¹´ 6 æœˆè‡³ 8 æœˆçš„ç­çº§ç”³è¯·ã€‚

## å¯¼èˆª

<div style="display: flex; align-items: center; width: 100%; justify-content: space-between; font-size: 1rem; color: #61758a; background-color: #f0f5f9; height: 4rem; padding: 0 1rem; border-radius: 1rem;">
<div style="display: flex;">
<i class="ri-home-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="../start.livemd">é¦–é¡µ</a>
</div>
<div style="display: flex;">
<i class="ri-bug-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="https://github.com/DockYard-Academy/curriculum/issues/new?assignees=&labels=&template=issue.md&title=Metaprogramming">æŠ¥å‘Šé—®é¢˜</a>
</div>
<div style="display: flex;">
<i class="ri-arrow-left-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="../exercises/advanced_score_tracker.livemd">é«˜çº§åˆ†æ•°è·Ÿè¸ªå™¨</a>
</div>
<div style="display: flex;">
<a style="display: flex; color: #61758a; margin-right: 1rem;" href="../exercises/meta_math.livemd">MetaMath</a>
<i class="ri-arrow-right-fill"></i>
</div>
</div>