# æµ‹è¯• GenServers

```elixir
Mix.install([
  {:jason, "~> 1.4"},
  {:kino, "~> 0.9", override: true},
  {:youtube, github: "brooklinjazz/youtube"},
  {:hidden_cell, github: "brooklinjazz/hidden_cell"}
])
```

## å¯¼èˆª

<div style="display: flex; align-items: center; width: 100%; justify-content: space-between; font-size: 1rem; color: #61758a; background-color: #f0f5f9; height: 4rem; padding: 0 1rem; border-radius: 1rem;">
<div style="display: flex;">
<i class="ri-home-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="../start.livemd">é¦–é¡µ</a>
</div>
<div style="display: flex;">
<i class="ri-bug-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="https://github.com/DockYard-Academy/curriculum/issues/new?assignees=&labels=&template=issue.md&title=Testing GenServers">æŠ¥å‘Šé—®é¢˜</a>
</div>
<div style="display: flex;">
<i class="ri-arrow-left-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="../exercises/timer.livemd">è®¡æ—¶å™¨</a>
</div>
<div style="display: flex;">
<a style="display: flex; color: #61758a; margin-right: 1rem;" href="../exercises/stack.livemd">æµ‹è¯•å †æ ˆ</a>
<i class="ri-arrow-right-fill"></i>
</div>
</div>

## å¤ä¹ é—®é¢˜

å®Œæˆæœ¬è¯¾åï¼Œå­¦ç”Ÿåº”è¯¥èƒ½å¤Ÿå›ç­”ä»¥ä¸‹é—®é¢˜ã€‚

* æˆ‘ä»¬å¦‚ä½•æµ‹è¯• [GenServer](https://hexdocs.pm/elixir/GenServer.html) çš„è¡Œä¸ºè€Œä¸æ˜¯å®ç°ï¼Ÿ

## æµ‹è¯• GenServers

æˆ‘ä»¬å·²ç»çœ‹åˆ°å¦‚ä½•å¯¹æ¨¡å—å’Œå‡½æ•°è¿›è¡Œæµ‹è¯•ï¼Œä½†å¦‚ä½•æµ‹è¯•åƒè¿›ç¨‹è¿™æ ·çš„æœ‰çŠ¶æ€çš„ä¸œè¥¿å‘¢ï¼Ÿè®©æˆ‘ä»¬è€ƒè™‘å¦‚ä½•æµ‹è¯•ä¸€ä¸ªç®€å•çš„ `CounterServer` è¿›ç¨‹ï¼Œå®ƒåº”è¯¥åœ¨å…¶çŠ¶æ€ä¸­å­˜å‚¨ä¸€ä¸ªæ•´æ•°å¹¶é€’å¢è¯¥å€¼ã€‚

```elixir
defmodule CounterServer do
  use GenServer

  @impl true
  def init(state) do
    {:ok, state}
  end

  @impl true
  def handle_call(:increment, _from, state) do
    {:reply, state + 1, state + 1}
  end

  @impl true
  def handle_call(:get_count, _from, state) do
    {:reply, state, state}
  end
end
```

é€šå¸¸ï¼Œæˆ‘ä»¬ä¸æƒ³æµ‹è¯•è®¡æ•°å™¨çš„å®ç°ï¼Œå› æ­¤æˆ‘ä»¬ä¸æƒ³ä½¿ç”¨ [GenServer](https://hexdocs.pm/elixir/GenServer.html) æ¨¡å—ç‰¹å®šåœ°å‘å®ƒå‘é€æ¶ˆæ¯ï¼Œä¹Ÿä¸æƒ³æµ‹è¯•è¿›ç¨‹çš„çŠ¶æ€ã€‚

ä¾‹å¦‚ï¼Œä»¥ä¸‹æµ‹è¯•ä¸å®ç°è€¦åˆã€‚

```elixir
ExUnit.start(auto_run: false)

defmodule CounterServerTest do
  use ExUnit.Case

  test "Counter receives :increment call" do
    {:ok, pid} = GenServer.start_link(CounterServer, 0)
    GenServer.call(pid, :increment) # æ­¤å¤„ä¸CounterServerçš„å®ç°è€¦åˆäº†
    assert :sys.get_state(pid) == 1
  end
end

ExUnit.run()
```

å› æ­¤ï¼Œå¦‚æœä»»ä½•å†…éƒ¨å‘ç”Ÿå˜åŒ–ï¼Œè¿™äº›æµ‹è¯•å¯èƒ½ä¼šå¤±è´¥ï¼Œå³ä½¿è®¡æ•°å™¨æ¨¡å—çš„è¡Œä¸ºæ²¡æœ‰å˜åŒ–ã€‚ç›¸åï¼Œæˆ‘ä»¬é€šå¸¸å¸Œæœ›åœ¨ [GenServer](https://hexdocs.pm/elixir/GenServer.html) çš„ [å®¢æˆ·ç«¯æ¥å£](https://hexdocs.pm/elixir/GenServer.html#module-client-server-apis) ä¸Šè¿›è¡Œæµ‹è¯•ã€‚

è¿™æ˜¯ä¸€ä¸ª `CounterClient` æ¨¡å—ï¼Œå®ƒåŒ…å« `CounterServer` æ¨¡å—çš„å®¢æˆ·ç«¯æ¥å£ã€‚

```elixir
defmodule CounterClient do
  def start_link(_opts) do
    GenServer.start_link(CounterServer, 0)
  end

  def increment(pid) do
    GenServer.call(pid, :increment)
  end

  def get_count(pid) do
    GenServer.call(pid, :get_count)
  end
end
```

ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æµ‹è¯•ä¸­ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚

```elixir
ExUnit.start(auto_run: false)

defmodule CounterClientTest do
  use ExUnit.Case

  test "increment/1" do
    {:ok, pid} = CounterClient.start_link([])
    CounterClient.increment(pid) # ä¸Serverå®ç°è§£è—•ï¼Œåªä¸è¡Œä¸ºæœ‰å…³
    assert CounterClient.get_count(pid) == 1
  end
end

ExUnit.run()
```

è¿™ä½¿æˆ‘ä»¬çš„æµ‹è¯•å¯¹ `CounterServer` çš„å®ç°å˜åŒ–æ›´åŠ ç¨³å¥ã€‚åªè¦å®¢æˆ·ç«¯æ¥å£ä¿æŒä¸å˜ï¼Œæµ‹è¯•å°±ä¸ä¼šå¤±è´¥ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬å†³å®šæ”¹å˜åœ¨è®¡æ•°å™¨ä¸­å­˜å‚¨çŠ¶æ€çš„æ–¹å¼ã€‚æˆ‘ä»¬å°†ä¸å†ä½¿ç”¨æ•´æ•°ï¼Œè€Œæ˜¯ä½¿ç”¨ `%{count: value}` æ˜ å°„ã€‚ä¸ºäº†ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å‡½æ•°æ”¾åœ¨ä¸€èµ·ã€‚

```elixir
defmodule CounterMapExample do
  use GenServer

  # å®¢æˆ·ç«¯

  def start_link(_opts) do
    GenServer.start_link(__MODULE__, %{count: 0})
  end

  def increment(pid) do
    GenServer.call(pid, :increment)
  end

  def get_count(pid) do
    GenServer.call(pid, :get_count)
  end

  # æœåŠ¡å™¨

  @impl true
  def init(state) do
    {:ok, state}
  end

  @impl true
  def handle_call(:get_count, _from, state) do
    {:reply, state.count, state}
  end

  @impl true
  def handle_call(:increment, _from, state) do
    {:reply, state.count + 1, %{state | count: state.count + 1}}
  end
end
```

æˆ‘ä»¬çš„æµ‹è¯•ä»ç„¶é€šè¿‡ï¼Œå› ä¸ºè¡Œä¸ºå’Œæ¥å£æ²¡æœ‰æ”¹å˜ã€‚

```elixir
ExUnit.start(auto_run: false)

defmodule CounterMapTest do
  use ExUnit.Case

  test "increment/1" do
    {:ok, pid} = CounterMapExample.start_link([])
    CounterMapExample.increment(pid)
    assert CounterMapExample.get_count(pid) == 1
  end
end

ExUnit.run()
```

ç„¶è€Œï¼Œæ—§çš„æµ‹è¯•å¥—ä»¶å¤±è´¥äº†ï¼Œå› ä¸ºå®ƒä¸åº•å±‚å®ç°è€¦åˆã€‚

```elixir
ExUnit.start(auto_run: false)

defmodule CounterMapExampleTest do
  use ExUnit.Case

  test "handle_call :increment" do
    {:ok, pid} = GenServer.start_link(CounterMapExample, 0) # ç«Ÿç„¶è¯´çš„æ˜¯è¿™ä¸ªå®ç°è€¦åˆğŸ˜“
    GenServer.call(pid, :increment)
    assert :sys.get_state(pid) == 1
  end
end

ExUnit.run()
```

æœ‰å…³æµ‹è¯• [GenServer](https://hexdocs.pm/elixir/GenServer.html) çš„æ›´å¤šä¿¡æ¯ï¼ŒTyler Young æœ‰ä¸€åœºå¾ˆæ£’çš„æ¼”è®²ã€‚

<!-- livebook:{"attrs":"eyJzb3VyY2UiOiJZb3VUdWJlLm5ldyhcImh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL3dhdGNoP3Y9RVpGTFBHN1Y3Uk1cIikiLCJ0aXRsZSI6IlRlc3RpbmcgR2VuU2VydmVycyJ9","chunks":null,"kind":"Elixir.HiddenCell","livebook_object":"smart_cell"} -->

```elixir
YouTube.new("https://www.youtube.com/watch?v=EZFLPG7V7RM")
```

### ä½ çš„å›åˆ

åœ¨ `CountDown` æ¨¡å—ä¸Šå®ç°å¹¶æµ‹è¯•ä¸€ä¸ª `decrement/1` å‡½æ•°ã€‚

```elixir
defmodule CountDown do
  use GenServer

  # å®¢æˆ·ç«¯

  def start_link(_opts) do
    # å®ç°
  end

  def decrement(pid) do
    # å®ç°
  end

  # æœåŠ¡å™¨

  @impl true
  def init(state) do
    {:ok, state}
  end

  @impl true
  def handle_call(:get_count, _from, state) do
    # å®ç°
  end

  @impl true
  def handle_call(:decrement, _from, state) do
    # å®ç°
  end
end

ExUnit.start(auto_run: false)

defmodule CounterTest do
  use ExUnit.Case

  # å®ç°ä½ çš„æµ‹è¯•
  test "decrement/1"
end

ExUnit.run()
```

## æäº¤ä½ çš„è¿›åº¦

DockYard Academy ç°åœ¨å»ºè®®ä½ ä½¿ç”¨æœ€æ–°çš„ [Release](https://github.com/DockYard-Academy/curriculum/releases)ï¼Œè€Œä¸æ˜¯åˆ†å‰æˆ–å…‹éš†æˆ‘ä»¬çš„ä»“åº“ã€‚

è¿è¡Œ `git status` ä»¥ç¡®ä¿æ²¡æœ‰ä¸å¿…è¦çš„æ›´æ”¹ã€‚
ç„¶ååœ¨ `curriculum` æ–‡ä»¶å¤¹ä¸­ä»å‘½ä»¤è¡Œè¿è¡Œä»¥ä¸‹å‘½ä»¤ä»¥æäº¤ä½ çš„è¿›åº¦ã€‚

```
$ git add .
$ git commit -m "å®Œæˆæµ‹è¯• GenServers é˜…è¯»"
$ git push
```

æˆ‘ä»¬è‡ªè±ªåœ°æä¾›æˆ‘ä»¬çš„å¼€æºè¯¾ç¨‹ï¼Œä¾›ä»»ä½•äººå…è´¹å­¦ä¹ ï¼ŒæŒ‰ç…§è‡ªå·±çš„èŠ‚å¥è¿›è¡Œã€‚

æˆ‘ä»¬è¿˜æä¾›ä»˜è´¹è¯¾ç¨‹ï¼Œä½ å¯ä»¥åœ¨åŒä¼´çš„é™ªä¼´ä¸‹å‘è®²å¸ˆå­¦ä¹ ã€‚
æˆ‘ä»¬å°†å¾ˆå¿«æ¥å— 2023 å¹´ 6 æœˆè‡³ 8 æœˆçš„è¯¾ç¨‹ç”³è¯·ã€‚

## å¯¼èˆª

<div style="display: flex; align-items: center; width: 100%; justify-content: space-between; font-size: 1rem; color: #61758a; background-color: #f0f5f9; height: 4rem; padding: 0 1rem; border-radius: 1rem;">
<div style="display: flex;">
<i class="ri-home-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="../start.livemd">é¦–é¡µ</a>
</div>
<div style="display: flex;">
<i class="ri-bug-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="https://github.com/DockYard-Academy/curriculum/issues/new?assignees=&labels=&template=issue.md&title=Testing GenServers">æŠ¥å‘Šé—®é¢˜</a>
</div>
<div style="display: flex;">
<i class="ri-arrow-left-fill"></i>
<a style="display: flex; color: #61758a; margin-left: 1rem;" href="../exercises/timer.livemd">è®¡æ—¶å™¨</a>
</div>
<div style="display: flex;">
<a style="display: flex; color: #61758a; margin-right: 1rem;" href="../exercises/stack.livemd">æµ‹è¯•å †æ ˆ</a>
<i class="ri-arrow-right-fill"></i>
</div>
</div>
